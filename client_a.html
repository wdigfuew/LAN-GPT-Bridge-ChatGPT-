<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT å±€åŸŸç½‘å®¢æˆ·ç«¯</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <!-- Marked.js ç”¨äº Markdown æ¸²æŸ“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js ç”¨äºä»£ç é«˜äº® -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <!-- KaTeX ç”¨äºæ•°å­¦å…¬å¼ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"></script>
    <!-- html2canvas ç”¨äº DOM æˆªå›¾ä¸‹è½½ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ç®€å•çš„ Markdown æ ·å¼é€‚é… */
        .prose pre {
            background-color: #F9F9F9;
            color: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            position: relative;
            /* ä¸ºå¤åˆ¶æŒ‰é’®å®šä½ */
            border: 1px solid #e5e7eb;
        }

        .dark .prose pre {
            background-color: #1f2937;
            color: #e5e7eb;
            border-color: transparent;
        }

        .prose code {
            background-color: #F9F9F9;
            color: #1f2937;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
        }

        .dark .prose code {
            background-color: #374151;
            color: #e5e7eb;
        }

        .prose p {
            margin-bottom: 0.8em;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.8em;
        }

        .prose ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.8em;
        }

        /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
        .prose table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
        }

        .prose th,
        .prose td {
            border: 1px solid #d1d5db;
            padding: 0.5rem;
        }

        .dark .prose th,
        .dark .prose td {
            border-color: #4b5563;
        }

        .prose th {
            background-color: #f3f4f6;
        }

        .dark .prose th {
            background-color: #374151;
        }

        /* å¼ºåˆ¶è¦†ç›–æ ·å¼ */
        .prose {
            overflow: visible !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }

        /* éšè— ChatGPT åŸç”Ÿçš„å¤åˆ¶æŒ‰é’®æˆ–å…¶ä»–æŒ‰é’® (åªä¿ç•™æˆ‘ä»¬çš„) */
        .prose pre button:not(.copy-btn) {
            display: none !important;
        }

        /* å¤åˆ¶æŒ‰é’®æ ·å¼ */
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #374151;
            /* Darker bg for contrast */
            color: #d1d5db;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0;
            /* é»˜è®¤éšè— */
            z-index: 10;
        }

        .dark .copy-btn {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .prose pre:hover .copy-btn {
            opacity: 1;
            /* hover æ—¶æ˜¾ç¤º */
        }

        .copy-btn:hover {
            background-color: #4b5563;
            color: white;
        }

        /* --- ChatGPT Raw HTML Compatibility Shim --- */
        /* å®šä¹‰ ChatGPT å†…éƒ¨ä½¿ç”¨çš„ CSS å˜é‡ï¼Œé˜²æ­¢ raw HTML æ¸²æŸ“ä¸ºé€æ˜/ä¸å¯è§ */
        :root {
            --bg-primary: #ffffff;
            --text-primary: #000000;
            --token-text-primary: #1f2937;
            --token-text-secondary: #4b5563;
            --token-bg-primary: #ffffff;
            --token-bg-secondary: #f3f4f6;
            --token-border-default: #e5e7eb;
            --token-border-light: #f3f4f6;
        }

        .dark {
            --bg-primary: #343541;
            --text-primary: #ffffff;
            --token-text-primary: #ececf1;
            --token-text-secondary: #c5c5d2;
            --token-bg-primary: #343541;
            --token-bg-secondary: #444654;
            --token-border-default: #565869;
            --token-border-light: #444654;
        }

        /* å¼ºåˆ¶éƒ¨åˆ† ChatGPT ç±»åå¯è§æ€§ */
        .popover {
            background-color: var(--token-bg-primary) !important;
            color: var(--token-text-primary) !important;
            border: 1px solid var(--token-border-default) !important;
        }

        /* --- Canvas Card Styles --- */
        .canvas-card {
            border: 1px solid #fb923c;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: var(--bg-primary);
            max-width: 100%;
            width: 100%;
            /* å¼ºåˆ¶å®½åº¦é“ºæ»¡çˆ¶å®¹å™¨ */
            box-sizing: border-box;
            /* å«è¾¹æ¡† */
        }

        .canvas-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: #fff7ed;
            border-bottom: 1px solid #fb923c;
        }

        .dark .canvas-toolbar {
            background-color: #431407;
            border-bottom-color: #c2410c;
        }

        .canvas-title {
            font-weight: bold;
            color: #ea580c;
            font-size: 0.875rem;
        }

        .canvas-actions {
            display: flex;
            gap: 0.5rem;
        }

        .canvas-action-btn {
            font-size: 0.75rem;
            padding: 0.2rem 0.6rem;
            border-radius: 0.25rem;
            border: 1px solid #fdba74;
            background-color: white;
            color: #c2410c;
            cursor: pointer;
            transition: all 0.2s;
        }

        .canvas-action-btn:hover {
            background-color: #ffedd5;
        }

        .dark .canvas-action-btn {
            background-color: #7c2d12;
            color: #ffedd5;
            border-color: #c2410c;
        }

        .canvas-body {
            padding: 1rem;
            overflow-x: auto;
            max-width: 100%;
            word-wrap: break-word;
            /* ç¡®ä¿é•¿æ–‡æœ¬æ¢è¡Œ */
        }

        /* Hide native buttons inside canvas body to clean up UI */
        .canvas-body button {
            display: none !important;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #343541;
        }

        ::-webkit-scrollbar-thumb {
            background: #565869;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #acacbe;
        }
    </style>
</head>

<body class="bg-[#343541] text-gray-100 flex h-screen overflow-hidden font-sans">

    <!-- ä¾§è¾¹æ  -->
    <div id="sidebar"
        class="w-[260px] bg-gray-50 dark:bg-[#202123] p-2 flex flex-col hidden md:flex border-r border-gray-200 dark:border-gray-600 h-full z-50 transition-colors duration-200">
        <!-- é¡¶éƒ¨ï¼šæ–°å»ºå¯¹è¯ + æ”¶èµ·æŒ‰é’® -->
        <div class="flex items-center gap-2 mb-2 shrink-0">
            <button onclick="startNewChat()"
                class="flex-1 flex items-center gap-3 px-3 py-3 rounded-md border border-gray-300 dark:border-white/20 hover:bg-gray-200 dark:hover:bg-gray-900 transition-colors text-sm text-gray-700 dark:text-white shrink-0">
                <span>+</span> æ–°å»ºå¯¹è¯
            </button>
            <button onclick="toggleSidebar()"
                class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition"
                title="æ”¶èµ·ä¾§è¾¹æ ">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="9" y1="3" x2="9" y2="21"></line>
                </svg>
            </button>
        </div>

        <!-- å†å²è®°å½•åŒºåŸŸ (å æ®å‰©ä½™ç©ºé—´) -->
        <div class="flex-1 flex flex-col min-h-0 overflow-hidden my-2">
            <div class="flex items-center justify-between px-2 mb-2 cursor-pointer group shrink-0"
                onclick="toggleHistoryList()">
                <div class="flex items-center gap-2">
                    <span
                        class="text-xs font-semibold text-gray-400 group-hover:text-white transition-colors uppercase tracking-wider">å†å²è®°å½•</span>
                    <svg id="history-list-chevron"
                        class="text-gray-500 group-hover:text-white transform transition-transform duration-200"
                        xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M6 9l6 6 6-6" />
                    </svg>
                </div>
                <!-- åˆ·æ–°æŒ‰é’® -->
                <button onclick="event.stopPropagation(); fetchHistoryList()"
                    class="text-gray-400 hover:text-white transition-colors p-1 rounded hover:bg-gray-800" title="åˆ·æ–°åˆ—è¡¨">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3" />
                    </svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto space-y-1 transition-all duration-300 pr-1" id="history-list">
                <!-- å†å²è®°å½•åˆ—è¡¨ -->
            </div>
        </div>

        <!-- åº•éƒ¨è®¾ç½®ä¸ä¿¡æ¯ -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-2 shrink-0 flex gap-2">
            <button onclick="showConfigModal()"
                class="flex-1 flex items-center justify-start gap-3 px-3 py-3 rounded-md hover:bg-gray-200 dark:hover:bg-gray-900 transition-colors text-sm text-gray-700 dark:text-white">
                <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round"
                    stroke-linejoin="round" class="h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l-.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z">
                    </path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <span>è®¾ç½®</span>
            </button>
            <button onclick="toggleTheme()"
                class="flex items-center justify-center px-3 py-3 rounded-md hover:bg-gray-200 dark:hover:bg-gray-900 transition-colors text-sm text-gray-700 dark:text-white"
                title="åˆ‡æ¢æ—¥é—´/å¤œé—´æ¨¡å¼">
                <!-- Sun Icon -->
                <svg id="theme-icon-sun" class="block dark:hidden h-5 w-5" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                    </path>
                </svg>
                <!-- Moon Icon -->
                <svg id="theme-icon-moon" class="hidden dark:block h-5 w-5" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">
                    </path>
                </svg>
            </button>
        </div>
        <div class="text-xs text-gray-500 text-left pl-4 p-2">
            åŒç¨‹åºå†…ç½‘ç©¿é€ç³»ç»Ÿ<br>Client A
        </div>
    </div>

    <!-- ä¸»èŠå¤©åŒºåŸŸ -->
    <div class="flex-1 flex flex-col relative w-full h-full bg-white dark:bg-[#343541] transition-colors duration-200">
        <!-- å±•å¼€ä¾§è¾¹æ æŒ‰é’® (æ‚¬æµ®) -->
        <button id="sidebar-open-btn" onclick="toggleSidebar()"
            class="absolute top-2 left-2 z-40 p-2 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white rounded hover:bg-gray-200 dark:hover:bg-gray-700/50 transition md:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="3" x2="9" y2="21"></line>
            </svg>
        </button>
        <!-- èŠå¤©è®°å½•å®¹å™¨ -->
        <div id="chat-container" class="flex-1 overflow-y-auto w-full p-4 pb-32 scroll-smooth">
            <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
            <button id="load-more-btn" onclick="loadMoreMessages()"
                class="hidden w-full py-2 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-white/5 rounded transition-colors mb-4">
                æŸ¥çœ‹æ›´å¤šå†å²æ¶ˆæ¯
            </button>

            <!-- æ¬¢è¿è¯­ -->
            <div class="flex flex-col items-center justify-center h-full text-center space-y-4" id="welcome-screen">
                <h1 class="text-4xl font-bold text-gray-800 dark:text-gray-200 transition-colors">ChatGPT Bridge</h1>
                <p class="text-gray-600 dark:text-gray-400 transition-colors">è¯·ç¡®ä¿ B ç«¯æœåŠ¡å·²è¿è¡Œå¹¶é…ç½®è¿æ¥</p>
                <div class="flex gap-2">
                    <button onclick="showConfigModal()"
                        class="px-4 py-2 bg-[#10a37f] hover:bg-[#1a7f64] rounded text-white transition">è®¾ç½®è¿æ¥</button>
                </div>
            </div>
            <!-- æ¶ˆæ¯åˆ—è¡¨ä¼šæ’å…¥åˆ°è¿™é‡Œ -->
        </div>

        <!-- åº•éƒ¨è¾“å…¥æ¡† -->
        <div
            class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-white via-white to-transparent dark:from-[#343541] dark:via-[#343541] dark:to-transparent pt-10 pb-6 px-4 transition-colors duration-200">
            <div
                class="max-w-3xl mx-auto bg-white dark:bg-[#40414f] rounded-lg shadow-xl border border-gray-200 dark:border-gray-600/50 flex flex-col gap-2 relative transition-colors duration-200">
                <textarea id="user-input" rows="1"
                    class="w-full bg-transparent text-gray-800 dark:text-white p-3 pr-10 outline-none resize-none max-h-[200px] overflow-y-auto m-0 transition-colors"
                    placeholder="å‘é€æ¶ˆæ¯..."></textarea>
                <button id="send-btn"
                    class="absolute right-2 bottom-2.5 p-1 rounded-md text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-900 disabled:opacity-40 transition"
                    disabled>
                    <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round"
                        stroke-linejoin="round" class="h-4 w-4" height="1em" width="1em"
                        xmlns="http://www.w3.org/2000/svg">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
            <div class="text-center text-xs text-gray-400 dark:text-gray-500 mt-2">Free Research Preview. è‡ªåŠ¨ç”Ÿæˆå†…å®¹å¯èƒ½ä¸å‡†ç¡®ã€‚
            </div>
        </div>
    </div>

    <!-- é…ç½®å¼¹çª— -->
    <div id="config-modal"
        class="hidden fixed inset-0 bg-black/50 dark:bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm transition-colors duration-200">
        <div
            class="bg-white dark:bg-[#202123] p-6 rounded-lg w-96 shadow-2xl border border-gray-300 dark:border-gray-600 relative transition-colors duration-200">
            <button onclick="closeConfigModal()"
                class="absolute top-2 right-2 text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">âœ•</button>
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">è¿æ¥é…ç½®</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æœåŠ¡ç«¯ IP åœ°å€
                        (Bç«¯)</label>
                    <input type="text" id="conf-ip" placeholder="192.168.1.X" value="127.0.0.1"
                        class="w-full bg-gray-50 dark:bg-[#343541] border border-gray-300 dark:border-gray-600 rounded p-2 text-gray-900 dark:text-white outline-none focus:border-[#10a37f] transition-colors">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ç«¯å£</label>
                    <input type="number" id="conf-port" placeholder="2222" value="2222"
                        class="w-full bg-gray-50 dark:bg-[#343541] border border-gray-300 dark:border-gray-600 rounded p-2 text-gray-900 dark:text-white outline-none focus:border-[#10a37f] transition-colors">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Auth Token</label>
                    <input type="password" id="conf-token" placeholder="ä¸ B ç«¯ç¯å¢ƒå˜é‡ä¸€è‡´" value="123456"
                        class="w-full bg-gray-50 dark:bg-[#343541] border border-gray-300 dark:border-gray-600 rounded p-2 text-gray-900 dark:text-white outline-none focus:border-[#10a37f] transition-colors">
                </div>
                <div id="conn-status" class="text-sm text-gray-500 dark:text-gray-400 h-5"></div>

                <div class="flex gap-2">
                    <button onclick="testConnection()"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-white py-2 rounded font-medium transition">æ£€æµ‹è¿æ¥</button>
                    <button onclick="connectWebSocket()"
                        class="flex-1 bg-[#10a37f] hover:bg-[#1a7f64] text-white py-2 rounded font-medium transition">ä¿å­˜å¹¶è¿æ¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ä¸»é¢˜åˆ‡æ¢é€»è¾‘ ---
        function initTheme() {
            // ä¼˜å…ˆè¯»å– localStorageï¼Œå¦åˆ™è·Ÿéšç³»ç»Ÿ
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }

        // ç«‹å³åˆå§‹åŒ–
        initTheme();

        // é…ç½® Marked.js ä½¿ç”¨ Highlight.js
        marked.setOptions({
            highlight: function (code, lang) {
                const language = highlight.getLanguage(lang) ? lang : 'plaintext';
                return highlight.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-'
        });

        // Math æ¸²æŸ“è¾…åŠ©å‡½æ•°
        function renderMath(element) {
            if (window.renderMathInElement) {
                renderMathInElement(element, {
                    delimiters: [
                        { left: '$$', right: '$$', display: true },
                        { left: '$', right: '$', display: false },
                        { left: '\\(', right: '\\)', display: false },
                        { left: '\\[', right: '\\]', display: true }
                    ],
                    throwOnError: false
                });
            }
        }

        // Math ä¿æŠ¤ä¸æ¢å¤æœºåˆ¶
        // é˜²æ­¢ Marked è§£æå™¨ç ´å LaTeX è¯­æ³• (å¦‚ x_i è¢«è§£æä¸ºæ–œä½“)

        const mathExpressions = [];

        function escapeMath(text) {
            mathExpressions.length = 0; // æ¸…ç©º
            // åŒ¹é…é¡ºåºå¾ˆé‡è¦ï¼šå…ˆåŒ¹é…å—çº§ $$...$$ å’Œ \[...\]ï¼Œå†åŒ¹é…è¡Œå†… \(...\) å’Œ $...$
            // æ³¨æ„ï¼šJSæ­£åˆ™ä¸æ”¯æŒ (?R) é€’å½’ï¼Œè¿™é‡Œç”¨ç®€å•è´ªå©ªåŒ¹é…ï¼Œå¯¹äºæåº¦å¤æ‚çš„åµŒå¥—å¯èƒ½æœ‰é™åˆ¶ï¼Œä½†å¯¹ GPT è¾“å‡ºé€šå¸¸è¶³å¤Ÿ

            // 1. Block: $$ ... $$
            text = text.replace(/\$\$([\s\S]*?)\$\$/g, (match) => {
                mathExpressions.push(match);
                return `MATH_BLOCK_${mathExpressions.length - 1}_END`;
            });

            // 2. Block: \[ ... \]
            text = text.replace(/\\\[([\s\S]*?)\\\]/g, (match) => {
                mathExpressions.push(match);
                return `MATH_BLOCK_${mathExpressions.length - 1}_END`;
            });

            // 3. Inline: \( ... \)
            text = text.replace(/\\\(([\s\S]*?)\\\)/g, (match) => {
                mathExpressions.push(match);
                return `MATH_INLINE_${mathExpressions.length - 1}_END`;
            });

            // 4. Inline: $ ... $ (æ’é™¤è´§å¸ç¬¦å·ï¼Œè¦æ±‚ $ åéç©ºä¸”éæ•°å­—å¼€å¤´å¯èƒ½æ¯”è¾ƒå®‰å…¨ï¼Œç®€å•èµ·è§å…ˆåŒ¹é…å¸¸è§æ•°å­¦æ¨¡å¼)
            // è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå±é™©çš„åŒ¹é…ï¼Œå› ä¸º $100 ä¼šè¢«è¯¯åˆ¤ã€‚
            // ç­–ç•¥ï¼šGPT é€šå¸¸ä½¿ç”¨ \( \) åšè¡Œå†…å…¬å¼ã€‚å¦‚æœå¿…é¡»æ”¯æŒ $ï¼Œå°½é‡ä¸¥æ ¼ã€‚
            // æš‚æ—¶è·³è¿‡ $...$ ä»¥å…è¯¯ä¼¤ï¼Œé™¤éç”¨æˆ·å¼ºçƒˆè¦æ±‚ã€‚GPT é»˜è®¤å¾ˆå°‘ç”¨ $ åŒ…è£¹å…¬å¼ã€‚

            return text;
        }

        function restoreMath(html) {
            return html.replace(/MATH_(BLOCK|INLINE)_(\d+)_END/g, (match, type, index) => {
                return mathExpressions[parseInt(index)] || match;
            });
        }

        let socket = null;
        let isConnected = false;
        let currentAssistantMessageDiv = null;
        let currentAssistantRawText = "";

        // åˆ†é¡µçŠ¶æ€
        let currentChatUrl = ""; // å½“å‰ä¼šè¯ ID
        let currentOffset = 0;   // å½“å‰æ¶ˆæ¯åç§»é‡

        // é¡µé¢å…ƒç´ 
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const configModal = document.getElementById('config-modal');
        const statusMsg = document.getElementById('conn-status');
        const welcomeScreen = document.getElementById('welcome-screen');
        const historyList = document.getElementById('history-list');
        const loadMoreBtn = document.getElementById('load-more-btn');

        // æ˜¾ç¤ºé…ç½®å¼¹çª—
        function showConfigModal() {
            configModal.classList.remove('hidden');
            statusMsg.innerText = "";
        }

        function closeConfigModal() {
            if (isConnected) {
                configModal.classList.add('hidden');
            } else {
                statusMsg.innerText = "è¯·å…ˆè¿æ¥æœåŠ¡å™¨";
            }
        }

        window.onload = () => {
            showConfigModal();
        };

        // ... (Ping æµ‹è¯•å‡½æ•°ä¿æŒä¸å˜ï¼Œç¯‡å¹…åŸå› çœç•¥ï¼Œå‡è®¾æ²¡æ”¹åŠ¨) ...
        function testConnection() {
            const ip = document.getElementById('conf-ip').value;
            const port = document.getElementById('conf-port').value;
            const token = document.getElementById('conf-token').value;

            if (!ip || !port) { statusMsg.innerText = "é…ç½®ä¸å®Œæ•´"; return; }
            statusMsg.innerText = "æ­£åœ¨å°è¯• Ping...";
            statusMsg.className = "text-sm text-yellow-400 h-5";

            const wsUrl = `ws://${ip}:${port}/ws?token=${token}`;
            const testWs = new WebSocket(wsUrl);
            let pongReceived = false;
            testWs.onopen = () => testWs.send(JSON.stringify({ type: "ping" }));
            testWs.onmessage = (evt) => {
                if (JSON.parse(evt.data).type === 'pong') {
                    pongReceived = true;
                    statusMsg.innerText = "âœ” è¿æ¥æˆåŠŸï¼";
                    statusMsg.className = "text-sm text-green-400 h-5";
                    testWs.close();
                }
            };
            testWs.onerror = () => { statusMsg.innerText = "âŒ è¿æ¥å¤±è´¥"; statusMsg.className = "text-sm text-red-400 h-5"; };
            setTimeout(() => { if (!pongReceived && testWs.readyState !== 3) testWs.close(); }, 3000);
        }

        function connectWebSocket() {
            const ip = document.getElementById('conf-ip').value;
            const port = document.getElementById('conf-port').value;
            const token = document.getElementById('conf-token').value;

            if (!ip || !port) { statusMsg.innerText = "è¯·è¾“å…¥ IP å’Œç«¯å£"; return; }
            statusMsg.innerText = "æ­£åœ¨å»ºç«‹é•¿è¿æ¥...";
            statusMsg.className = "text-sm text-yellow-400 h-5";

            if (socket) socket.close();
            const wsUrl = `ws://${ip}:${port}/ws?token=${token}`;

            try {
                socket = new WebSocket(wsUrl);
                socket.onopen = () => {
                    isConnected = true;
                    configModal.classList.add('hidden');
                    welcomeScreen.classList.add('hidden');
                    statusMsg.innerText = "è¿æ¥å·²å»ºç«‹";
                    appendSystemMessage(`å·²è¿æ¥åˆ° ${ip}:${port}`);
                    userInput.focus();

                    // è¿æ¥æˆåŠŸåï¼Œè‡ªåŠ¨è·å–å†å²åˆ—è¡¨
                    fetchHistoryList();
                };

                socket.onmessage = (event) => handleMessage(JSON.parse(event.data));

                socket.onclose = () => {
                    isConnected = false;
                    appendSystemMessage("è¿æ¥å·²æ–­å¼€");
                    statusMsg.innerText = "è¿æ¥å·²æ–­å¼€";
                    statusMsg.className = "text-sm text-red-400 h-5";
                };

                socket.onerror = (e) => { console.error(e); statusMsg.innerText = "è¿æ¥é”™è¯¯"; };

            } catch (e) {
                statusMsg.innerText = "è¿æ¥å¼‚å¸¸: " + e.message;
            }
        }

        function handleMessage(data) {
            if (data.type === 'delta') {
                if (!currentAssistantMessageDiv) createAssistantMessageBubble();
                currentAssistantRawText += data.content;

                // 1. ä¿æŠ¤å…¬å¼
                const protectedText = escapeMath(currentAssistantRawText);
                // 2. Markdown æ¸²æŸ“
                const html = marked.parse(protectedText);
                // 3. æ¢å¤å…¬å¼
                currentAssistantMessageDiv.innerHTML = restoreMath(html);

                // 4. Katex æ¸²æŸ“
                renderMath(currentAssistantMessageDiv);
                scrollToBottom();

            } else if (data.type === 'done') {
                currentAssistantMessageDiv = null;
                currentAssistantRawText = "";
                sendBtn.disabled = false;
                currentOffset += 2;

            } else if (data.type === 'full_response') {
                // æ”¶åˆ°å®Œæ•´ DOMï¼Œæ›¿æ¢å½“å‰å†…å®¹
                // å¦‚æœæ²¡æœ‰ currentAssistantMessageDiv (æ¯”å¦‚åˆ·æ–°é¡µé¢å), éœ€è¦æ‰¾åˆ°æœ€åä¸€ä¸ª GPT æ¶ˆæ¯
                // è¿™é‡Œå‡è®¾å®ƒæ˜¯å¯¹åˆšæ‰ delta çš„ä¿®æ­£

                // æ‰¾åˆ°æœ€åä¸€ä¸ª GPT æ¶ˆæ¯å®¹å™¨ (div.message-content)
                const allGptMsgs = chatContainer.querySelectorAll('.message-content');
                if (allGptMsgs.length > 0) {
                    const lastMsg = allGptMsgs[allGptMsgs.length - 1];
                    // ç›´æ¥æ›¿æ¢ INNER_HTML
                    lastMsg.innerHTML = data.content;
                    // å¯èƒ½è¿˜éœ€è¦é‡æ–°æ¸²æŸ“æ•°å­¦å…¬å¼? è™½ç„¶ DOM æ˜¯æŠ„è¿‡æ¥çš„ï¼Œä½† KaTeX æ¸²æŸ“è¿‡çš„é€šå¸¸æ˜¯ HTML/MathMLï¼Œ
                    // å¦‚æœæ˜¯ raw text é‡Œçš„ math, è¿™æ—¶å€™å·²ç»æ˜¯ rendered HTML äº†ã€‚
                    // ç®€å•èµ·è§ï¼Œä¸å†æ¬¡ renderMathï¼Œé™¤é DOM é‡Œçš„å…¬å¼æ˜¯æœªæ¸²æŸ“çš„ textã€‚
                    // ChatGPT çš„ DOM é€šå¸¸åŒ…å«å·²æ¸²æŸ“çš„å¤æ‚çš„ span ç»“æ„ã€‚
                }

            } else if (data.type === 'error') {
                appendSystemMessage("é”™è¯¯: " + data.message);
                sendBtn.disabled = false;

            } else if (data.type === 'history_list') {
                renderHistoryList(data.data);

            } else if (data.type === 'message_history') {
                // æ¸²æŸ“å†å²æ¶ˆæ¯ (prepend)
                prependTimeoutMessages(data.data);

                // ... (rest is same)

            } else if (data.type === 'new_chat_success') {
                // ... (same as before)
                chatContainer.innerHTML = "";
                chatContainer.appendChild(loadMoreBtn);
                loadMoreBtn.classList.add('hidden');
                currentOffset = 0;
                currentChatUrl = "";
                appendSystemMessage("å·²å¼€å§‹æ–°å¯¹è¯");
                fetchHistoryList();
            }
        }

        // --- ä¾§è¾¹æ æŠ˜å åŠŸèƒ½ ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const openBtn = document.getElementById('sidebar-open-btn');

            // é€»è¾‘ï¼š
            // 1. å¦‚æœå½“å‰æ˜¯éšè—ï¼ˆhiddenï¼‰ï¼Œåˆ™ç§»é™¤ hiddenï¼Œå¹¶ç¡®ä¿æ˜¾ç¤º
            // 2. å¦‚æœå½“å‰æ˜¯æ˜¾ç¤ºï¼Œåˆ™æ·»åŠ  hidden
            // æ³¨æ„ï¼šTailwind çš„ md:flex ä¼šåœ¨å®½å±å¼ºåˆ¶æ˜¾ç¤º flexã€‚
            // ä¸ºäº†èƒ½æ‰‹åŠ¨éšè—ï¼Œæˆ‘ä»¬éœ€è¦ toggle ä¸€ä¸ªèƒ½è¦†ç›– md:flex çš„ç±»ï¼Œæˆ–è€…ç›´æ¥æ“ä½œ style
            // ä½†æœ€ç®€å•çš„æ˜¯ï¼štoggle 'hidden' å¹¶ç§»é™¤/æ·»åŠ  'md:flex'

            if (sidebar.classList.contains('hidden')) {
                // å±•å¼€
                sidebar.classList.remove('hidden');
                sidebar.classList.add('flex'); // ç¡®ä¿å®ƒæ˜¯ flex å¸ƒå±€
                sidebar.classList.add('md:flex'); // æ¢å¤å“åº”å¼

                openBtn.classList.add('md:hidden'); // å¤§å±ä¸‹éšè—æ‰“å¼€æŒ‰é’®
                openBtn.classList.add('hidden');    // å°å±ä¸‹ä¹Ÿéšè—ï¼ˆå› ä¸ºä¾§è¾¹æ ç›–ä½äº†æˆ–è€…æ¨å¼€äº†ï¼‰
                // å®é™…ä¸Šå°å±å¦‚æœæ˜¯è¦†ç›–å¼ï¼Œæ‰“å¼€æŒ‰é’®åº”è¯¥éšè—ï¼›å¦‚æœæ˜¯æ¨å¼€å¼ï¼Œä¹Ÿéšè—ã€‚
            } else {
                // æ”¶èµ·
                sidebar.classList.add('hidden');
                sidebar.classList.remove('flex');
                sidebar.classList.remove('md:flex'); // ç§»é™¤ md:flex é˜²æ­¢å¤§å±è‡ªåŠ¨æ˜¾ç¤º

                openBtn.classList.remove('md:hidden'); // å¤§å±ä¸‹æ˜¾ç¤ºæ‰“å¼€æŒ‰é’®
                openBtn.classList.remove('hidden');    // å°å±ä¸‹æ˜¾ç¤ºæ‰“å¼€æŒ‰é’®
            }
        }

        // --- æ–°å»ºå¯¹è¯åŠŸèƒ½ ---
        function startNewChat() {
            if (!isConnected) {
                appendSystemMessage("è¯·å…ˆè¿æ¥ B ç«¯æœåŠ¡");
                return;
            }
            appendSystemMessage("æ­£åœ¨åˆ›å»ºæ–°å¯¹è¯...");
            socket.send(JSON.stringify({ type: "new_chat" }));
        }

        // --- å†å²è®°å½•åˆ—è¡¨åŠŸèƒ½ ---
        function toggleHistoryList() {
            const list = document.getElementById('history-list');
            const chevron = document.getElementById('history-list-chevron');

            if (list.classList.contains('hidden')) {
                list.classList.remove('hidden');
                // æ¢å¤ flex
                list.classList.add('flex-1');
                chevron.style.transform = "rotate(0deg)";
            } else {
                list.classList.add('hidden');
                list.classList.remove('flex-1');
                chevron.style.transform = "rotate(-90deg)";
            }
        }

        function fetchHistoryList() {
            if (isConnected) socket.send(JSON.stringify({ type: "get_history" }));
        }

        function renderHistoryList(list) {
            historyList.innerHTML = "";
            list.forEach(item => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-[#2A2B32] rounded flex items-center gap-2 truncate transition-colors";
                btn.innerHTML = `
                    <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 shrink-0" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    <span class="truncate">${item.title}</span>
                `;
                btn.onclick = () => switchChat(item.id);
                historyList.appendChild(btn);
            });
        }

        function switchChat(url) {
            if (!isConnected) return;
            currentChatUrl = url;
            currentOffset = 0; // é‡ç½®åˆ†é¡µ

            // æ¸…ç©ºå½“å‰ç•Œé¢
            chatContainer.innerHTML = "";
            // é‡æ–°æŠŠ load more æŒ‰é’®åŠ å›å» (è™½ç„¶å®ƒç°åœ¨æ˜¯éšè—çš„)
            chatContainer.appendChild(loadMoreBtn);
            loadMoreBtn.classList.add('hidden');

            appendSystemMessage("æ­£åœ¨åˆ‡æ¢ä¼šè¯...");
            socket.send(JSON.stringify({ type: "switch_chat", url: url }));
        }

        // --- æ¶ˆæ¯åˆ†é¡µåŠŸèƒ½ ---
        function loadMoreMessages() {
            if (!isConnected) return;
            // æ¯æ¬¡åŠ è½½ 10 æ¡
            const limit = 10;
            loadMoreBtn.innerText = "åŠ è½½ä¸­...";
            loadMoreBtn.disabled = true;

            socket.send(JSON.stringify({
                type: "get_messages",
                limit: limit,
                offset: currentOffset
            }));

            // æ›´æ–° offset (è™½ç„¶æœåŠ¡ç«¯å¯èƒ½æ²¡è¿”å›é‚£ä¹ˆå¤šï¼Œè¿™é‡Œç®€å•ç´¯è®¡ï¼Œæ›´ä¸¥è°¨çš„åšæ³•æ˜¯æœåŠ¡ç«¯è¿”å›å®é™…æ•°é‡)
            currentOffset += limit;
        }

        function prependTimeoutMessages(messages) {
            // ... (setup code same as before)
            loadMoreBtn.disabled = false;
            loadMoreBtn.innerText = "æŸ¥çœ‹æ›´å¤šå†å²æ¶ˆæ¯";

            if (messages.length === 0) {
                loadMoreBtn.innerText = "æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†";
                loadMoreBtn.disabled = true;
                return;
            }

            loadMoreBtn.classList.remove('hidden');

            const oldHeight = chatContainer.scrollHeight;
            const oldScrollTop = chatContainer.scrollTop;

            const fragment = document.createDocumentFragment();

            messages.forEach(msg => {
                const div = document.createElement('div');
                const isUser = msg.role === 'user';
                const isCanvas = msg.role === 'canvas';

                let bgColor = "bg-[#F9F9F9] dark:bg-[#444654]";
                let avatarHtml = `<div class="w-[30px] h-[30px] bg-[#10a37f] rounded-sm flex items-center justify-center text-white text-xs font-bold">GPT</div>`;

                if (isUser) {
                    bgColor = "bg-white dark:bg-gray-800";
                    avatarHtml = `<div class="w-[30px] h-[30px] bg-purple-500 rounded-sm flex items-center justify-center text-white text-xs font-bold">You</div>`;
                } else if (isCanvas) {
                    bgColor = "bg-orange-50 dark:bg-orange-900/20"; // Canvas ç‰¹æ®ŠèƒŒæ™¯
                    avatarHtml = `<div class="w-[30px] h-[30px] bg-orange-500 rounded-sm flex items-center justify-center text-white text-xs font-bold">Can</div>`;
                }

                div.className = `w-full border-b border-black/10 dark:border-gray-900/50 text-gray-800 dark:text-gray-100 ${bgColor} group`;

                let finalHtml = "";

                if (msg.is_html) {
                    // å¦‚æœæ˜¯ HTML (æœåŠ¡ç«¯çˆ¬å–çš„ DOM)ï¼Œç›´æ¥ä½¿ç”¨
                    finalHtml = msg.content;
                } else {
                    // å†å²å…¼å®¹ï¼šå¦‚æœæ˜¯çº¯æ–‡æœ¬ï¼Œèµ° Markdown æ¸²æŸ“
                    const protectedContent = escapeMath(msg.content);
                    const renderedHtml = marked.parse(protectedContent);
                    finalHtml = restoreMath(renderedHtml);
                }

                // åªæœ‰ GPT æ¶ˆæ¯ä½¿ç”¨ prose æ ·å¼ï¼Œç”¨æˆ·æ¶ˆæ¯ä¿æŒæ™®é€šæ–‡æœ¬æ ¼å¼ä»¥é¿å…å¸ƒå±€é—®é¢˜
                // Canvas ä¹Ÿå¯ä»¥ä½¿ç”¨ prose
                const contentClass = isUser ?
                    "relative flex-1 min-w-0 overflow-hidden min-h-[20px] whitespace-pre-wrap text-left" :
                    "relative flex-1 min-w-0 overflow-hidden prose prose-invert max-w-none message-content text-left";

                div.innerHTML = `
                    <div class="text-base gap-4 md:gap-6 md:max-w-2xl lg:max-w-[38rem] xl:max-w-3xl p-4 md:py-6 flex lg:px-0 m-auto">
                        <div class="flex-shrink-0 flex flex-col relative items-start">
                            ${avatarHtml}
                        </div>
                        <div class="${contentClass}">
                            <!-- Content Placeholder -->
                        </div>
                    </div>
                `;

                // [Modified] Inject content: use renderCanvasCard for canvas, standard HTML for others
                const contentContainer = div.querySelector(`.${contentClass.split(' ').pop()}`); // naive selector, better use index
                // actually contentClass is complex, let's select by .relative.flex-1
                const targetDiv = div.querySelector('.relative.flex-1');

                if (isCanvas) {
                    const canvasCard = renderCanvasCard(finalHtml);
                    targetDiv.appendChild(canvasCard);
                } else {
                    targetDiv.innerHTML = finalHtml;
                }

                // åªæœ‰å½“ä¸æ˜¯åŸç”Ÿ HTML æ—¶æ‰éœ€è¦ renderMath? 
                // æˆ–è€…ä¿å®ˆä¸€ç‚¹éƒ½è·‘ä¸€é? 
                // å¦‚æœæ˜¯åŸç”Ÿ DOMï¼ŒKaTeX ç±»åå¯èƒ½å†²çªï¼Œä½†é€šå¸¸æ²¡é—®é¢˜ã€‚
                if (!msg.is_html) {
                    renderMath(div);
                }
                fragment.appendChild(div);
            });

            // ... (insert logic) ...

            // æ’å…¥åˆ° loadMoreBtn åé¢ (å³ä½œä¸ºç¬¬ä¸€ä¸ªæ¶ˆæ¯å—)
            // chatContainer firstChild æ˜¯ loadMoreBtn
            // æ‰€ä»¥å¯ä»¥ç›´æ¥ insertBefore åˆ° loadMoreBtn.nextSibling
            // æˆ–è€…æ›´ç®€å•ï¼šç›´æ¥ insertAfter loadMoreBtn

            // æ³¨æ„ï¼šmessage_history è¿”å›çš„é¡ºåºã€‚å¦‚æœ Server æ˜¯æŒ‰ DOM é¡ºåº (æ—§ -> æ–°)
            // é‚£ä¹ˆæˆ‘ä»¬ç›´æ¥ append åˆ° fragmentï¼Œç„¶åæŠŠæ•´ä¸ª fragment æ’å…¥åˆ°æœ€ä¸Šé¢
            // ä½†å¦‚æœæ˜¯åœ¨ switch_chat æ—¶è§¦å‘ (offset=0, limit=6)ï¼Œè¿™ä¹Ÿæ˜¯â€œæœ€æ–°çš„6æ¡â€

            // é€»è¾‘ä¿®æ­£ï¼š
            // å¦‚æœæ˜¯ switch_chat è§¦å‘ (offset=0)ï¼Œæˆ‘ä»¬é€šå¸¸æ˜¯æ¸…ç©ºäº†ç•Œé¢ã€‚è¿™æ—¶å€™åº”è¯¥ç›´æ¥ append åˆ°åé¢ã€‚
            // ä½†å› ä¸ºæˆ‘ä»¬è®¾è®¡äº† loadMoreBtn åœ¨æœ€ä¸Šé¢ã€‚

            if (currentOffset <= 10 && chatContainer.children.length <= 2) {
                // åˆšåˆ‡æ¢çš„æƒ…å†µ (<=2 æ˜¯å› ä¸ºæœ‰ä¸€ä¸ª loadMoreBtn å’Œå¯èƒ½ä¸€ä¸ª system msg)
                // ç›´æ¥è¿½åŠ åˆ°åé¢ï¼Œå¹¶æ»šåŠ¨åˆ°åº•éƒ¨
                chatContainer.appendChild(fragment);
                scrollToBottom();
                // è®¾ç½®åˆå§‹ offset
                currentOffset = messages.length;
            } else {
                // åŠ è½½å†å²çš„æƒ…å†µï¼šæ’å…¥åˆ° loadMoreBtn ä¹‹å
                if (loadMoreBtn.nextSibling) {
                    chatContainer.insertBefore(fragment, loadMoreBtn.nextSibling);
                } else {
                    chatContainer.appendChild(fragment);
                }

                // æ¢å¤æ»šåŠ¨ä½ç½®
                // æ–°é«˜åº¦ - æ—§é«˜åº¦ = æ’å…¥å†…å®¹çš„é«˜åº¦
                // æˆ‘ä»¬å¸Œæœ›è§†å£ä½ç½®ç›¸å¯¹äºåº•éƒ¨å†…å®¹ä¸å˜ -> å®é™…ä¸Šç›¸å¯¹äºé¡¶éƒ¨å˜äº†
                // ç®€å•çš„åšæ³•ï¼šscrollTo currentPosition + (newHeight - oldHeight)
                const newHeight = chatContainer.scrollHeight;
                chatContainer.scrollTop = oldScrollTop + (newHeight - oldHeight);
            }
        }

        // --- åŸºç¡€èŠå¤©åŠŸèƒ½ ---

        function appendUserMessage(text) {
            const div = document.createElement('div');
            div.className = "w-full border-b border-black/10 dark:border-gray-900/50 text-gray-800 dark:text-gray-100 bg-white dark:bg-gray-800 group";
            div.innerHTML = `
                <div class="text-base gap-4 md:gap-6 md:max-w-2xl lg:max-w-[38rem] xl:max-w-3xl p-4 md:py-6 flex lg:px-0 m-auto">
                    <div class="flex-shrink-0 flex flex-col relative items-end">
                        <div class="w-[30px] h-[30px] bg-purple-500 rounded-sm flex items-center justify-center text-white text-xs font-bold">You</div>
                    </div>
                    <div class="relative flex-1 min-w-0 overflow-hidden min-h-[20px] whitespace-pre-wrap text-left">${text}</div>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function createAssistantMessageBubble() {
            const div = document.createElement('div');
            div.className = "w-full border-b border-black/10 dark:border-gray-900/50 text-gray-800 dark:text-gray-100 bg-[#F9F9F9] dark:bg-[#444654] group";
            div.innerHTML = `
                <div class="text-base gap-4 md:gap-6 md:max-w-2xl lg:max-w-[38rem] xl:max-w-3xl p-4 md:py-6 flex lg:px-0 m-auto">
                    <div class="flex-shrink-0 flex flex-col relative items-end">
                        <div class="w-[30px] h-[30px] bg-[#10a37f] rounded-sm flex items-center justify-center text-white text-xs font-bold">GPT</div>
                    </div>
                    <div class="relative flex-1 min-w-0 overflow-hidden prose prose-invert max-w-none message-content">
                        <span class="animate-pulse">â–</span>
                    </div>
                </div>
            `;
            chatContainer.appendChild(div);
            currentAssistantMessageDiv = div.querySelector('.message-content');
            scrollToBottom();
            currentOffset += 1;
        }

        function appendSystemMessage(text) {
            const div = document.createElement('div');
            div.className = "w-full p-2 text-center text-xs text-gray-500";
            div.innerText = text;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function sendMessage() {
            const text = userInput.value.trim();
            if (!text || !isConnected) return;
            appendUserMessage(text);
            socket.send(JSON.stringify({ type: "chat", message: text }));
            userInput.value = "";
            userInput.style.height = 'auto';
            sendBtn.disabled = true;
        }

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        userInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if (this.value.trim().length > 0) {
                sendBtn.disabled = !isConnected;
                sendBtn.classList.add('text-white');
            } else {
                sendBtn.classList.remove('text-white');
            }
        });

        // --- Canvas æ¸²æŸ“ä¸åŠŸèƒ½å°è£… ---
        function renderCanvasCard(content) {
            // åˆ›å»ºå¡ç‰‡å®¹å™¨
            const card = document.createElement('div');
            card.className = "canvas-card";

            // å¤´éƒ¨å·¥å…·æ 
            const toolbar = document.createElement('div');
            toolbar.className = "canvas-toolbar";

            // æ ‡é¢˜
            const title = document.createElement('div');
            title.className = "canvas-title";
            title.innerHTML = "Canvas Preview"; // æˆ–æ ¹æ®å†…å®¹åˆ¤æ–­ç±»å‹

            // æŒ‰é’®ç»„
            const actions = document.createElement('div');
            actions.className = "canvas-actions";

            // å¤åˆ¶æŒ‰é’®
            const copyBtn = document.createElement('button');
            copyBtn.className = "canvas-action-btn";
            copyBtn.innerHTML = "ğŸ“‹ å¤åˆ¶å†…å®¹";
            copyBtn.onclick = () => {
                const text = body.innerText; // è·å–çº¯æ–‡æœ¬
                navigator.clipboard.writeText(text).then(() => {
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = "âœ… å·²å¤åˆ¶";
                    setTimeout(() => copyBtn.innerHTML = originalText, 2000);
                }).catch(err => {
                    console.error("å¤åˆ¶å¤±è´¥:", err);
                    alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•");
                });
            };

            // ä¸‹è½½å›¾ç‰‡æŒ‰é’®
            const downloadBtn = document.createElement('button');
            downloadBtn.className = "canvas-action-btn";
            downloadBtn.innerHTML = "ğŸ–¼ï¸ å­˜ä¸ºå›¾ç‰‡";
            downloadBtn.onclick = () => {
                const originalText = downloadBtn.innerHTML;
                downloadBtn.innerHTML = "â³ å¤„ç†ä¸­...";

                // ä½¿ç”¨ html2canvas æˆªå›¾
                html2canvas(body, {
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-primary') || '#ffffff',
                    scale: 2, // æé«˜æ¸…æ™°åº¦
                    logging: false,
                    useCORS: true
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'canvas-snapshot-' + Date.now() + '.png';
                    link.href = canvas.toDataURL();
                    link.click();
                    downloadBtn.innerHTML = "âœ… å·²ä¸‹è½½";
                    setTimeout(() => downloadBtn.innerHTML = originalText, 2000);
                }).catch(err => {
                    console.error("ç”Ÿæˆå›¾ç‰‡å¤±è´¥:", err);
                    downloadBtn.innerHTML = "âŒ å¤±è´¥";
                    setTimeout(() => downloadBtn.innerHTML = originalText, 2000);
                });
            };

            // ç»„è£…å¤´éƒ¨
            actions.appendChild(copyBtn);
            actions.appendChild(downloadBtn);
            toolbar.appendChild(title);
            toolbar.appendChild(actions);
            card.appendChild(toolbar);

            // å†…å®¹åŒºåŸŸ
            const body = document.createElement('div');
            body.className = "canvas-body prose prose-invert max-w-none"; // ä¿æŒ prose æ ·å¼ä»¥æ¸²æŸ“ markdown
            body.innerHTML = content;
            card.appendChild(body);

            return card;
        }

        // --- å¤åˆ¶ä»£ç æŒ‰é’®åŠŸèƒ½ ---
        function addCopyButtons(container) {
            // æŸ¥æ‰¾æ‰€æœ‰ pre æ ‡ç­¾ (ä»£ç å—)
            const preBlocks = container.querySelectorAll('pre');
            preBlocks.forEach(pre => {
                // æ¸…ç†åŸç”ŸæŒ‰é’®: éšè—é™¤äº† .copy-btn ä»¥å¤–çš„æ‰€æœ‰ button
                const nativeBtns = pre.querySelectorAll('button:not(.copy-btn)');
                nativeBtns.forEach(btn => btn.style.display = 'none');

                // å¦‚æœå·²ç»æœ‰æŒ‰é’®äº†ï¼Œè·³è¿‡ (é˜²æ­¢é‡å¤æ·»åŠ )
                if (pre.querySelector('.copy-btn')) return;

                const btn = document.createElement('button');
                btn.className = 'copy-btn';
                btn.innerText = 'å¤åˆ¶ä»£ç ';
                btn.onclick = (e) => {
                    e.stopPropagation(); // é˜²æ­¢è§¦å‘å…¶ä»–ç‚¹å‡»äº‹ä»¶

                    // 1. å°è¯•è·å– code æ ‡ç­¾
                    const codeElement = pre.querySelector('code');
                    let codeText = "";

                    if (codeElement) {
                        codeText = codeElement.innerText;
                    } else {
                        // 2. å¦‚æœæ²¡æœ‰ code æ ‡ç­¾ï¼Œè·å– pre çš„æ–‡æœ¬ï¼Œä½†è¦æ’é™¤ copy-btn
                        // å…‹éš†èŠ‚ç‚¹ä»¥é¿å…ä¿®æ”¹ DOM
                        const clone = pre.cloneNode(true);
                        const clonedBtn = clone.querySelector('.copy-btn');
                        if (clonedBtn) clonedBtn.remove();
                        codeText = clone.innerText;
                    }

                    if (!codeText) {
                        btn.innerText = 'æ— å†…å®¹';
                        setTimeout(() => btn.innerText = 'å¤åˆ¶ä»£ç ', 2000);
                        return;
                    }

                    navigator.clipboard.writeText(codeText).then(() => {
                        btn.innerText = 'å·²å¤åˆ¶!';
                        setTimeout(() => btn.innerText = 'å¤åˆ¶ä»£ç ', 2000);
                    }).catch(err => {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                        btn.innerText = 'å¤±è´¥';
                        // å¤‡ç”¨æ–¹æ¡ˆï¼šåˆ›å»ºä¸€ä¸ª textarea æ¥å¤åˆ¶
                        try {
                            const textArea = document.createElement("textarea");
                            textArea.value = codeText;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand("copy");
                            document.body.removeChild(textArea);
                            btn.innerText = 'å·²å¤åˆ¶!';
                            setTimeout(() => btn.innerText = 'å¤åˆ¶ä»£ç ', 2000);
                        } catch (err2) {
                            console.error('å¤‡ç”¨å¤åˆ¶ä¹Ÿå¤±è´¥:', err2);
                        }
                    });
                };

                pre.appendChild(btn);
            });
        }

        // ä½¿ç”¨ MutationObserver ç›‘å¬ chatContainer å˜åŒ–ï¼Œè‡ªåŠ¨æ·»åŠ æŒ‰é’®
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // å…ƒç´ èŠ‚ç‚¹
                        addCopyButtons(node);
                        // ä¹Ÿè¦å¤„ç† node å†…éƒ¨çš„å…ƒç´ 
                        if (node.querySelectorAll) {
                            addCopyButtons(node);
                        }
                    }
                });
            });
        });

        observer.observe(chatContainer, { childList: true, subtree: true });
    </script>
</body>

</html>